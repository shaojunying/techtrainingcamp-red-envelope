<?xml version="1.0" encoding="UTF-8"?>
<svg width="1200" height="800" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <style>
      .title { font-family: 'Segoe UI', Arial, sans-serif; font-size: 20px; font-weight: bold; fill: #2c3e50; }
      .step-title { font-family: 'Segoe UI', Arial, sans-serif; font-size: 13px; font-weight: bold; fill: #2c3e50; }
      .step-desc { font-family: 'Segoe UI', Arial, sans-serif; font-size: 10px; fill: #7f8c8d; }
      .legend-text { font-family: 'Segoe UI', Arial, sans-serif; font-size: 11px; fill: #34495e; }
      .metric-text { font-family: 'Segoe UI', Arial, sans-serif; font-size: 11px; fill: #2c3e50; }
      
      .start-box { fill: #e8f5e8; stroke: #27ae60; stroke-width: 2; rx: 8; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.1)); }
      .process-box { fill: #e3f2fd; stroke: #3498db; stroke-width: 2; rx: 8; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.1)); }
      .decision-diamond { fill: #fff3e0; stroke: #f39c12; stroke-width: 2; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.1)); }
      .success-box { fill: #e8f5e8; stroke: #2ecc71; stroke-width: 2; rx: 8; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.1)); }
      .fail-box { fill: #fdedec; stroke: #e74c3c; stroke-width: 2; rx: 8; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.1)); }
      .storage-box { fill: #fdf2e9; stroke: #e67e22; stroke-width: 2; rx: 8; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.1)); }
      .async-box { fill: #f4ecf7; stroke: #8e44ad; stroke-width: 2; rx: 8; filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.1)); }
      
      .flow-arrow { stroke: #34495e; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .success-arrow { stroke: #27ae60; stroke-width: 2; fill: none; marker-end: url(#arrowhead-success); }
      .fail-arrow { stroke: #e74c3c; stroke-width: 2; fill: none; marker-end: url(#arrowhead-fail); }
      .async-arrow { stroke: #8e44ad; stroke-width: 2; fill: none; marker-end: url(#arrowhead-async); stroke-dasharray: 5,5; }
      .data-arrow { stroke: #e67e22; stroke-width: 2; fill: none; marker-end: url(#arrowhead-data); }
      
      .layer-bg { fill: #fafbfc; stroke: #bdc3c7; stroke-width: 1; rx: 8; opacity: 0.6; }
    </style>
    
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#34495e" />
    </marker>
    <marker id="arrowhead-success" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#27ae60" />
    </marker>
    <marker id="arrowhead-fail" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#e74c3c" />
    </marker>
    <marker id="arrowhead-async" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#8e44ad" />
    </marker>
    <marker id="arrowhead-data" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#e67e22" />
    </marker>
  </defs>
  
  <!-- Title -->
  <text x="600" y="30" text-anchor="middle" class="title">红包雨系统业务流程图</text>
  
  <!-- Main Flow Section -->
  <rect x="50" y="60" width="1100" height="240" class="layer-bg"/>
  <text x="70" y="85" class="title" style="font-size: 16px;">核心业务流程</text>
  
  <!-- Step 1: User Request -->
  <rect x="80" y="110" width="120" height="60" class="start-box"/>
  <text x="140" y="135" text-anchor="middle" class="step-title">用户发起请求</text>
  <text x="140" y="150" text-anchor="middle" class="step-desc">POST /snatch</text>
  <text x="140" y="162" text-anchor="middle" class="step-desc">{"uid": 123}</text>
  
  <!-- Step 2: Rate Limiting -->
  <polygon points="250,110 320,140 250,170 180,140" class="decision-diamond"/>
  <text x="250" y="135" text-anchor="middle" class="step-title">限流检查</text>
  <text x="250" y="150" text-anchor="middle" class="step-desc">令牌桶算法</text>
  <text x="250" y="162" text-anchor="middle" class="step-desc">5000 QPS</text>
  
  <!-- Step 3: Anti-Cheat -->
  <polygon points="370,110 440,140 370,170 300,140" class="decision-diamond"/>
  <text x="370" y="135" text-anchor="middle" class="step-title">反作弊</text>
  <text x="370" y="150" text-anchor="middle" class="step-desc">时间间隔</text>
  <text x="370" y="162" text-anchor="middle" class="step-desc">1秒限制</text>
  
  <!-- Step 4: User Limit Check -->
  <polygon points="490,110 560,140 490,170 420,140" class="decision-diamond"/>
  <text x="490" y="130" text-anchor="middle" class="step-title">用户限制</text>
  <text x="490" y="145" text-anchor="middle" class="step-desc">检查次数</text>
  <text x="490" y="157" text-anchor="middle" class="step-desc">最多5次</text>
  
  <!-- Step 5: Probability Check -->
  <polygon points="610,110 680,140 610,170 540,140" class="decision-diamond"/>
  <text x="610" y="135" text-anchor="middle" class="step-title">概率检查</text>
  <text x="610" y="150" text-anchor="middle" class="step-desc">成功概率</text>
  <text x="610" y="162" text-anchor="middle" class="step-desc">70%</text>
  
  <!-- Step 6: Generate Envelope -->
  <rect x="730" y="110" width="120" height="60" class="process-box"/>
  <text x="790" y="135" text-anchor="middle" class="step-title">生成红包</text>
  <text x="790" y="150" text-anchor="middle" class="step-desc">计算金额</text>
  <text x="790" y="162" text-anchor="middle" class="step-desc">创建记录</text>
  
  <!-- Success Response -->
  <rect x="900" y="110" width="120" height="60" class="success-box"/>
  <text x="960" y="135" text-anchor="middle" class="step-title">返回成功</text>
  <text x="960" y="150" text-anchor="middle" class="step-desc">envelope_id</text>
  <text x="960" y="162" text-anchor="middle" class="step-desc">code: 0</text>
  
  <!-- Failure Responses Row -->
  <rect x="150" y="220" width="100" height="40" class="fail-box"/>
  <text x="200" y="240" text-anchor="middle" class="step-title">限流失败</text>
  <text x="200" y="252" text-anchor="middle" class="step-desc">code: 7</text>
  
  <rect x="280" y="220" width="100" height="40" class="fail-box"/>
  <text x="330" y="240" text-anchor="middle" class="step-title">作弊检测</text>
  <text x="330" y="252" text-anchor="middle" class="step-desc">code: 7</text>
  
  <rect x="410" y="220" width="100" height="40" class="fail-box"/>
  <text x="460" y="240" text-anchor="middle" class="step-title">次数超限</text>
  <text x="460" y="252" text-anchor="middle" class="step-desc">code: 2</text>
  
  <rect x="540" y="220" width="100" height="40" class="fail-box"/>
  <text x="590" y="240" text-anchor="middle" class="step-title">概率失败</text>
  <text x="590" y="252" text-anchor="middle" class="step-desc">code: 1</text>
  
  <!-- Data Storage Section -->
  <rect x="50" y="320" width="550" height="140" class="layer-bg"/>
  <text x="70" y="345" class="title" style="font-size: 16px;">数据存储</text>
  
  <rect x="80" y="370" width="120" height="50" class="storage-box"/>
  <text x="140" y="390" text-anchor="middle" class="step-title">Redis缓存</text>
  <text x="140" y="405" text-anchor="middle" class="step-desc">用户状态/限制</text>
  
  <rect x="230" y="370" width="120" height="50" class="storage-box"/>
  <text x="290" y="390" text-anchor="middle" class="step-title">MySQL数据库</text>
  <text x="290" y="405" text-anchor="middle" class="step-desc">红包记录</text>
  
  <rect x="380" y="370" width="120" height="50" class="storage-box"/>
  <text x="440" y="390" text-anchor="middle" class="step-title">RocketMQ</text>
  <text x="440" y="405" text-anchor="middle" class="step-desc">异步消息</text>
  
  <!-- Consumer Processing Section -->
  <rect x="650" y="320" width="500" height="140" class="layer-bg"/>
  <text x="670" y="345" class="title" style="font-size: 16px;">异步处理</text>
  
  <rect x="680" y="370" width="120" height="50" class="async-box"/>
  <text x="740" y="390" text-anchor="middle" class="step-title">Consumer1</text>
  <text x="740" y="405" text-anchor="middle" class="step-desc">业务处理</text>
  
  <rect x="830" y="370" width="120" height="50" class="async-box"/>
  <text x="890" y="390" text-anchor="middle" class="step-title">Consumer2</text>
  <text x="890" y="405" text-anchor="middle" class="step-desc">数据同步</text>
  
  <rect x="980" y="370" width="120" height="50" class="storage-box"/>
  <text x="1040" y="390" text-anchor="middle" class="step-title">业务数据库</text>
  <text x="1040" y="405" text-anchor="middle" class="step-desc">数据持久化</text>
  
  <!-- Secondary Flows Section -->
  <rect x="50" y="480" width="1100" height="120" class="layer-bg"/>
  <text x="70" y="505" class="title" style="font-size: 16px;">其他业务流程</text>
  
  <!-- Open Envelope Flow -->
  <rect x="80" y="530" width="120" height="50" class="start-box"/>
  <text x="140" y="550" text-anchor="middle" class="step-title">开红包请求</text>
  <text x="140" y="565" text-anchor="middle" class="step-desc">POST /open</text>
  
  <polygon points="250,530 320,555 250,580 180,555" class="decision-diamond"/>
  <text x="250" y="550" text-anchor="middle" class="step-title">验证红包</text>
  <text x="250" y="565" text-anchor="middle" class="step-desc">是否已开启</text>
  
  <rect x="370" y="530" width="120" height="50" class="success-box"/>
  <text x="430" y="550" text-anchor="middle" class="step-title">返回金额</text>
  <text x="430" y="565" text-anchor="middle" class="step-desc">更新状态</text>
  
  <!-- Wallet Query Flow -->
  <rect x="550" y="530" width="120" height="50" class="start-box"/>
  <text x="610" y="550" text-anchor="middle" class="step-title">钱包查询</text>
  <text x="610" y="565" text-anchor="middle" class="step-desc">GET /wallet</text>
  
  <rect x="720" y="530" width="120" height="50" class="process-box"/>
  <text x="780" y="550" text-anchor="middle" class="step-title">查询记录</text>
  <text x="780" y="565" text-anchor="middle" class="step-desc">用户红包列表</text>
  
  <rect x="890" y="530" width="120" height="50" class="success-box"/>
  <text x="950" y="550" text-anchor="middle" class="step-title">返回列表</text>
  <text x="950" y="565" text-anchor="middle" class="step-desc">总金额统计</text>
  
  <!-- Main Flow Arrows -->
  <line x1="200" y1="140" x2="180" y2="140" class="flow-arrow"/>
  <line x1="320" y1="140" x2="300" y2="140" class="flow-arrow"/>
  <line x1="440" y1="140" x2="420" y2="140" class="flow-arrow"/>
  <line x1="560" y1="140" x2="540" y2="140" class="flow-arrow"/>
  <line x1="680" y1="140" x2="730" y2="140" class="success-arrow"/>
  <line x1="850" y1="140" x2="900" y2="140" class="success-arrow"/>
  
  <!-- Failure Arrows -->
  <line x1="230" y1="160" x2="200" y2="220" class="fail-arrow"/>
  <line x1="350" y1="160" x2="330" y2="220" class="fail-arrow"/>
  <line x1="470" y1="160" x2="460" y2="220" class="fail-arrow"/>
  <line x1="590" y1="160" x2="590" y2="220" class="fail-arrow"/>
  
  <!-- Data Storage Arrows -->
  <line x1="490" y1="180" x2="140" y2="370" class="data-arrow"/>
  <line x1="790" y1="170" x2="290" y2="370" class="data-arrow"/>
  <line x1="790" y1="170" x2="440" y2="370" class="data-arrow"/>
  
  <!-- Async Processing Arrows -->
  <line x1="500" y1="395" x2="680" y2="395" class="async-arrow"/>
  <line x1="800" y1="395" x2="830" y2="395" class="async-arrow"/>
  <line x1="950" y1="395" x2="980" y2="395" class="async-arrow"/>
  
  <!-- Secondary Flow Arrows -->
  <line x1="200" y1="555" x2="180" y2="555" class="flow-arrow"/>
  <line x1="320" y1="555" x2="370" y2="555" class="success-arrow"/>
  <line x1="670" y1="555" x2="720" y2="555" class="flow-arrow"/>
  <line x1="840" y1="555" x2="890" y2="555" class="flow-arrow"/>
  
  <!-- Legend -->
  <rect x="50" y="630" width="1100" height="140" class="layer-bg"/>
  <text x="70" y="655" class="title" style="font-size: 16px;">图例说明</text>
  
  <!-- Legend Items -->
  <line x1="80" y1="680" x2="130" y2="680" class="flow-arrow"/>
  <text x="140" y="685" class="legend-text">正常流程</text>
  
  <line x1="240" y1="680" x2="290" y2="680" class="success-arrow"/>
  <text x="300" y="685" class="legend-text">成功路径</text>
  
  <line x1="400" y1="680" x2="450" y2="680" class="fail-arrow"/>
  <text x="460" y="685" class="legend-text">失败路径</text>
  
  <line x1="560" y1="680" x2="610" y2="680" class="async-arrow"/>
  <text x="620" y="685" class="legend-text">异步处理</text>
  
  <line x1="720" y1="680" x2="770" y2="680" class="data-arrow"/>
  <text x="780" y="685" class="legend-text">数据操作</text>
  
  <!-- Performance Metrics -->
  <text x="80" y="715" class="title" style="font-size: 14px;">性能参数:</text>
  <text x="80" y="735" class="metric-text">• 限流: 5000 QPS (令牌桶算法)</text>
  <text x="80" y="750" class="metric-text">• 反作弊: 同用户1秒间隔限制</text>
  <text x="80" y="765" class="metric-text">• 业务规则: 70%成功概率，每人最多5次</text>
  
  <text x="400" y="715" class="title" style="font-size: 14px;">存储策略:</text>
  <text x="400" y="735" class="metric-text">• Redis: 用户状态缓存 (过期时间1小时)</text>
  <text x="400" y="750" class="metric-text">• MySQL: 红包记录持久化存储</text>
  <text x="400" y="765" class="metric-text">• RocketMQ: 异步消息队列处理</text>
  
  <text x="750" y="715" class="title" style="font-size: 14px;">错误码:</text>
  <text x="750" y="735" class="metric-text">• 0: 成功  • 1: 概率失败  • 2: 次数超限</text>
  <text x="750" y="750" class="metric-text">• 3: 参数错误  • 4: 已开启  • 5: 不存在</text>
  <text x="750" y="765" class="metric-text">• 6: 系统错误  • 7: 请求频繁</text>
</svg>